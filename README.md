# MPI-gemm-multiply
```
C=alpha*A*B + beta * C
```

## Settings using docker:
```bash
source dockervars.sh
```

## Build:
```
mpicc gemm.c -o gemm
```

## Run:
```
mpirun -np 5 gemm
```
## Example of output:
```
start with 5 tasks.
Initializing arrays...
line to be killed 8
A Matrix:

  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  1.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  1.00  1.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  1.00  1.00  1.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  1.00  1.00  1.00  1.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  1.00  1.00  1.00  1.00  1.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  1.00  1.00  1.00  1.00  1.00  1.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00
_________________________________________________________
B Matrix:

  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00
  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00  0.00
  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00
  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00
  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00
  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00
  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00
  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00
  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00
  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00
  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00
  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00  1.00
_________________________________________________________
C Matrix:

  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00  5.00
  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00  7.00
  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00  9.00
 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00 11.00
 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00 13.00
 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00 15.00
 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00 17.00
 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00 19.00
 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00 21.00
 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00 23.00
_________________________________________________________
Sending 4 rows to task 1 offset=0
Sending 3 rows to task 2 offset=4
Sending 3 rows to task 3 offset=7
num_proc 3 computed_line 7 
num_proc 1 computed_line 0num_proc 2 computed_line 4 
 
num_proc 2 computed_line 5 
num_proc 1 computed_line 1 
num_proc 2 computed_line 6 
num_proc 1 computed_line 2 
num_proc 1 computed_line 3 
killed line 8
Proc: 3   line in A matrix: 8 SIGKILLED
Received results from task 1
Received results from task 2
Rank 3: Notified of error MPI_ERR_PROC_FAILED: Process Failure. Resend procedure has started
Sending 3 rows to task 4 offset=7
DONE !!!! Sent 3 rows to task 4 offset=7
Proc: 4 is finding need recovery file....
Received results from task 4
******************************************************
Result Matrix:

  7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50     7.50   
 11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70    11.70   
 15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90    15.90   
 20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10    20.10   
 24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30    24.30   
 28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50    28.50   
 32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70    32.70   
 36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90    36.90   
 41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10    41.10   
 45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30    45.30   
******************************************************
Done.

```
## Recovery part
Используем сохраненные текстовые файлы на диске и начинаем вычисление в резервном процессе со строчки i_start.
```c

     char name[20];
     int lines;
     int for_rec = -3;
     printf("Proc: %d is finding need recovery file....\n", taskid);


     snprintf(name, sizeof name, "proc_%d_%d.txt", broken_proc, broken_line);

     lines = broken_line;

     while (lines >= 0){

       FILE *f = fopen(name, "r");
       if (f == NULL) {
         i_start = lines - 1;

       }
       else{

         for_rec = broken_line - offset;

           // all scanf to do!!!!
         i_start = i + 1;

         fclose(f);
         break;
       }
       lines = lines - 1;
     }


     //scanf from recovery files
     while (for_rec >= 0){
       snprintf(name, sizeof name, "proc_%d_%d.txt", broken_proc, (for_rec+offset) );
       FILE *f_rec = fopen(name, "r");
       for (int j = 0; j < NCB; j++) {
         fscanf(f_rec, "%lf", &c[for_rec][j]);
       }
       fclose(f_rec);
     }


     for (int i = i_start; i < rows; i++){
       for (int k = 0; k < NCB; k++)
       {

           c[i][k] *= BETA;


           for (int j = 0; j < NCA; j++){


              c[i][k] = c[i][k] + ALPHA * a[i][j] * b[j][k];
           }

        }
     }

```
